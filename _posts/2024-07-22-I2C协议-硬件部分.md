---
layout: post

title: I2C协议
categories: [协议]
tags: [通信,协议,I2C]
typora-root-url: ..
---

## I2C协议 硬件部分

#### 介绍

​	I2C（Inter-[ integrated circuit](https://www.myfreax.com/i2c-communication-protocol-basics/#) 发音为“eye-squared-see”，内部继承总线）是一种允许从不同的芯片或电路与不同的主芯片通信的协议。它仅用于短距离通信。它在电线的使用方面具有优势，因为它只需要 2 根电线，但仅这 2 根电线就可以支持 1008个设备。

#### 物理层

![常见的I2C通讯系统](./assets/pics/i2cbus002.png)

它的物理层有如下特点：

- 支持多设备的总线，多个设备共用相同的总线。支持多个通信主机和从机。
- 总线由两条物理线路构成，一条双向串行数据线(serial data)，一条串行时钟线(serial clock)。由时钟线解决数据同步问题，由数据线传输数据。
- 每个链接到总线的设备都拥有独立的设备地址，该地址为7bit或10bit。
- 总线通过上拉电阻接到电源。当I2C设备空闲时，会输出高阻态，而当所有设备都空闲， 都输出高阻态时，由上拉电阻把总线拉成高电平。
- 当多个主机争用总线时，采用仲裁的方式分配。

- 具有三种传输模式：标准模式传输速率为100kbit/s ，快速模式为400kbit/s ， 高速模式下可达 3.4Mbit/s，但目前大多I2C设备尚不支持高速模式。
- 连接到相同总线的 IC 数量受到总线的最大电容 400pF 限制 。

#### 协议层

​	协议层的工作有，**通讯的起始和停止信号**、**数据有效性**、**响应**、**仲裁**、**时钟同步**和**地址广播**。

##### 线路状态

**默认状态**

​	在数据静默时，总线上的电平均**为高**。

**起始信号**

​	SCL总线为high，SDA总线由high变为low。

**停止条件**

​	SCL总线为high，SDA总线由low变为high。

![图片](./assets/pics/640-20240723203751273)

**传输0/1**

​	当SCL为高电平时，SDA保持的状态就是传输的数据。

​	当SCL为低电平时，SDA准备数据可以改变。

​	![图片](./assets/pics/640)

**传输一个字节**

![图片](./assets/pics/640-20240723203901986)

​		一个字节是8bit，最后一位为ACK，所以传输一个byte，需要多传一个bit。你也可能遇到不标准的I2C芯片或者自行设计的I2C协议设备，它并不强制要求检查每一字节后的响应位，但是**仍然需要将这一位的传输保留**，即NACK，可以将SDA在这一位保持高电平。

​	此外，I2C传输的大小端为从MSB到LSB。

##### 冷启动与热启动

![img](./assets/pics/2812660-20220506120521527-745432034.png)

①冷启动（简称启动S），指的是总线处于空闲状态时主机发起的启动，包含主机通电后处于空闲状态时首次发起的启动和主机工作一段时间停止后处于空闲状态时发起的启动。

②热启动（简称重启Sr），指的是主机在连续工作时，不用停止总线而发起的重启。

简而概之，冷启动是停止条件发生后，总线“冷”下来处于空闲状态时，主机发起的启动；热启动是不用停止总线，主机在工作中重新发起的启动。



##### 时钟同步

​	如果总线上只有一个Master设备，整个通信过程非常简单，这个Master就是“国王”，是总线传输的**唯一发起者**，所有Slave都得乖乖的听话。它想要和谁通信就主动发起，不用考虑总线是否有其他数据正在传输。不想通信的时候，所有Slave都得悄悄的等着召见。

​	当总线上存在多个master的时候，那么首先统一clk是第一件事。

![图片](./assets/pics/640-20240723205134697)

​	由于硬件采用**开漏模式**（线“与”的逻辑功能），所以总线上的电平以低电平优先。

​	如上图，有2个Master设备发起通讯，2号Master的时钟CLK2比CLK1要晚一点。

​	当2号Master发现自己的CLK为“1”时，总线SCL上已经是“0”了，它就会**提前调整自己的时序**，马上拉低CLK，**赶上大部队的节奏**。

​	当1号Master发现自己的CLK已经为“1”时，总线SCL上还是“0”，它就会**放慢自己的脚步**，一直等待总线变为“1”，**接着跟大家一起走**。

​	经过几轮的折腾，所有的设备CLK便基本保持同步了。

##### 总线仲裁

​	当统一时钟之后便可以发送数据来进行协商仲裁了。

![图片](./assets/pics/640-20240723205335196)

　假设主控器1要发送的数据DATA1为“101 ……”；主控器2要发送的数据DATA2为“1001 ……”

​	首先：当总线被启动后两个主控器在每发送一个数据位时都要对自己的输出电平进行检测，只要检测的电平与自己发出的电平一致，他们就会继续占用总线。在这种情况下总线还是得不到仲裁。当主控器1发送第3位数据“1”时（主控器2发送“0” ），由于“线与”的结果SDA上的电平为“0”，这样当主控器1检测自己的输出电平时，就会测到一个与自身不相符的“0”电平。这时主控器1只好放弃对总线的控制权；因此主控器2就成为总线的唯一主宰者。不难看出：

- 对于整个仲裁过程主控器1和主控器2都不会丢失数据；
- 各个主控器没有对总线实施控制的优先级别，他们遵循“低电平优先”的原则，即谁先发送低电平谁就会掌握对总线的控制权。

i2c总线仲裁主要遵循三个机制：

- **“线与”机制：**多主机时，总线具有“线与”的逻辑功能，即只要有一个节点发送低电平时，总线上就表现为低电平。

- **SDA回读机制**总线被启动后，多个主机在每发送一个数据位时都要对自己的输出电平进行检测，只要检测的电平与自己发出的电平一致，就会继续占用总线。

- **低电平优先机制**由于线与的存在，当多主机发送时，谁先发送低电平谁就会掌握对总线的控制权。

#### 通信协议

![图片](./assets/pics/640-20240723210341803)

​	如上图，由Master通过1个起始信号发起通讯，接着发送7bit的Slave地址位和1bit的**“读/写”指示位**，如Slave的地址为10bit，需要将地址拆分成2个字节发送。其目的是告诉所有Slave，要访问谁，要做什么操作。相应的Slave会马上**应答一个ACK**。接下来Master就可以根据需要以字节为单位发送或者接收数据了。Master在数据传输结束时发送一个停止信号，结束此次通信。

**协议的基本格式为“S + SlaveAddr + ACK + Data(8bit) +** **ACK/ NACK** **+** **… + P“**

##### 时钟拉伸

​	值得一提的是，在每一次字节传输完，Slave应答后，SCL都可能会持续保持为“0”一段时间。这并不是Master的行为，**而是Slave主动将SCL总线拉低一段时间**。这种设置是为了让响应速度较慢的Slave能够**“拽”住**速度快的Master，以实现双方的**“步调一致”**。比如Slave设备在收到1个字节数据后进行存储，存储的时间较长，这时候就需要“提醒”Master，**让它等一等**。

**主机向从机发送**

![img](./assets/pics/2812660-20220506120521393-1149516549.png)

**从机向主机发送**

![img](./assets/pics/2812660-20220506120520194-2010443249.png)

##### 混合发送

![img](./assets/pics/2812660-20220506120520975-1917409911.png)



#### 特殊地址

| **目标地址** | **读/写位** | **描述**                |
| ------------ | ----------- | ----------------------- |
| 0000 000     | 0           | 广播呼叫地址[1]         |
| 0000 000     | 1           | 启动字节[2]             |
| 0000 001     | X           | CBUS地址[3]             |
| 0000 010     | X           | 为不同的总线格式保留[4] |
| 0000 011     | X           | 保留供将来使用          |
| 0000 1XX     | X           | 高速模式主机代码        |
| 1111 1XX     | 1           | 设备ID                  |
| 1111 0XX     | X           | 10位目标寻址            |



##### 广播呼叫地址与寻找设备

​	主机启动I2C总线后，第一字节首先发送广播呼叫地址(0000 0000)，如果某些从机不需要被呼叫寻址，它可以通过不应答（NACK）来忽略这个地址。

​	如果某些设备确实需要传输数据，它就发送应答（ACK）信号来确认这个地址并作为一个从机接收器。如果一个或多个从机做出应答响应，主机实际上并不知道有多少从机进行了应答。

​	第二个字节及以后的字节由每个能够处理该数据的从机接收器接收并确认。不能处理这些字节的从机必须通过不应答（NACK）来忽略它。

![img](./assets/pics/2812660-20220506120521044-1068085388.png)	主机紧接着发送第二个字节，第二个字节是控制地址，是表示呼叫目的和含义的字节，其具体含义如下	

1）第二字节第八位B=0时，含义如下：

①0000 0110 （06h）：从机硬件复位和写数据到从机内部存储空间。从机接收到第一字节和本字节序列后，被寻址的所有从机复位，并接收主机接下来发送的数据，存入自己内部存储空间（内部存储空间地址具体规范由从机规格书给出）。

​	注意，确保从机在刚开始施加电源电压后不会拉低SDA或SCL线，因为这些低电平会阻塞总线。

②0000 0100 (04h)：写数据到从机内部存储空间。过程如上，但不会复位硬件。

③0000 0000 (00h)：此代码不允许用作第二个字节。

④除了以上三个字节数据定义外，其余的字节数据定义官方尚未更新添加，设备必须忽略它们。具体的软件编程要求在相应的设备器件数据表中有详细规定。

2）第二字节第八位B=1时，含义如下：

​	当第二字节的第八位B=1时，前七位表示主机自己的地址，这种序列组合表示“硬件广播”。从机接收到第一字节和本字节序列后，被寻址的所有从机将第二字节的前七位标识备案为主机的地址。如果这个主机同时也具有从机的功能的话，则该主机可以转换到从机身份，其从机地址就是已备案的七位地址，该转换后的从机身份及从机地址受到其他主机的控制。

​	例如键盘，由于键盘扫描仪不知道连接的设备到底是谁，所以以主机的身份发送第一字节“00000000”和第二字节“xxxxxxx1”组合序列，发起硬件广播，被呼叫寻址的从机登记备案键盘的7位地址，然后身份互换，键盘转为从机，原来从机转换为主机，现在的主机把7位键盘的地址作为从机地址寻址键盘，从而控制键盘和从键盘获取键值，当然这些身份转换的设备要同时具备主机和从机的功能。

​	但是例如i2c-detect工具，并没有主机和从机转换的过程。因为从机不一定具备主机的能力。所以才用了遍历所有地址的方式。

#### 总线清除

​	总线清除指的是清除总线被卡死在低电平的故障，使其恢复正常状态。

​	在极少数情况下， 如果SCL时钟总线被卡在低电平（长时间陷在低电平状态），对其正确的处理方式为：①如果您的I2C设备有硬件复位输入，那么首先使用硬件复位信号复位I2C总线。②如果I2C设备没有硬件复位输入，则重启电源供电以强制激活设备内部硬件上电复位(POR)电路，实施开机复位I2C总线状态机。

​	在极少数情况下，如果SDA数据总线被卡在低电平（长时间陷在低电平状态），对其正确的处理方式为：①主机应发送9个时钟脉冲，将SDA总线保持在低电平的设备应该会在这9个时钟周期内的某个时间将其释放。②如果9个时钟周期内没有释放，则使用硬件复位或重启电源复位来清除总线

#### 设备ID

在出厂前，芯片制造商将设备ID（身份编码）存储在芯片内部的只读存储空间，设备ID包含内容如下（如图1-38所示）：

①  12位芯片制造商名称编码，每个制造商都是唯一的(例如“0000 0000 0000”代表恩智浦)。

②  9位芯片器件标识码，芯片制造商分配（例如AT24C02）。

③  3位芯片版本，由制造商指定(例如RevX)

![img](./assets/pics/2812660-20220506120718236-633405126.png)

https://www.cnblogs.com/deliweier-wangshuping/p/16228208.html







#### 大小端，MSB，LSB

小端：高字节在高地址，注意是字节

大端：高字节在低地址，字节。

MSB（Most Significant Bit）：最高有效位，二进制中代表最高值的比特位，这一位对数值的影响最大。

LSB（Least Significant Bit）：最低有效位，二进制中代表最低值的比特位

https://www.cnblogs.com/lingyejun/p/8312838.html